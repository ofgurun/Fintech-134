@page
@model InteraktifKredi.Web.Pages.Dashboard.ProfileModel
@{
    ViewData["Title"] = "Profil & Ayarlar";
    Layout = "_DashboardLayout";
}

<!-- ========================================================================
     PROFILE PAGE - TABBED FORM SYSTEM
======================================================================== -->

<div class="dashboard_page">
    <!-- Page Header -->
    <div class="dashboard_page__header">
        <h2 class="dashboard_page__title">Profil & Ayarlar</h2>
        <p class="dashboard_page__description">
            Ki≈üisel bilgilerinizi g√ºncelleyin ve hesap ayarlarƒ±nƒ±zƒ± y√∂netin.
        </p>
    </div>

    <!-- Success/Error Messages -->
    @if (!string.IsNullOrEmpty(Model.SuccessMessage))
    {
        <div class="alert alert--success">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M10 18C14.4183 18 18 14.4183 18 10C18 5.58172 14.4183 2 10 2C5.58172 2 2 5.58172 2 10C2 14.4183 5.58172 18 10 18ZM13.7071 8.70711C14.0976 8.31658 14.0976 7.68342 13.7071 7.29289C13.3166 6.90237 12.6834 6.90237 12.2929 7.29289L9 10.5858L7.70711 9.29289C7.31658 8.90237 6.68342 8.90237 6.29289 9.29289C5.90237 9.68342 5.90237 10.3166 6.29289 10.7071L8.29289 12.7071C8.68342 13.0976 9.31658 13.0976 9.70711 12.7071L13.7071 8.70711Z" fill="currentColor"/>
            </svg>
            <span>@Model.SuccessMessage</span>
        </div>
    }

    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert--error">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M10 18C14.4183 18 18 14.4183 18 10C18 5.58172 14.4183 2 10 2C5.58172 2 2 5.58172 2 10C2 14.4183 5.58172 18 10 18ZM8.70711 7.29289C8.31658 6.90237 7.68342 6.90237 7.29289 7.29289C6.90237 7.68342 6.90237 8.31658 7.29289 8.70711L8.58579 10L7.29289 11.2929C6.90237 11.6834 6.90237 12.3166 7.29289 12.7071C7.68342 13.0976 8.31658 13.0976 8.70711 12.7071L10 11.4142L11.2929 12.7071C11.6834 13.0976 12.3166 13.0976 12.7071 12.7071C13.0976 12.3166 13.0976 11.6834 12.7071 11.2929L11.4142 10L12.7071 8.70711C13.0976 8.31658 13.0976 7.68342 12.7071 7.29289C12.3166 6.90237 11.6834 6.90237 11.2929 7.29289L10 8.58579L8.70711 7.29289Z" fill="currentColor"/>
            </svg>
            <span>@Model.ErrorMessage</span>
        </div>
    }

    <!-- Tabs Container -->
    <div class="profile_tabs">
        <!-- Tab Navigation -->
        <div class="profile_tabs__nav">
            <button type="button" class="profile_tabs__nav_item profile_tabs__nav_item--active" data-tab="address">
                <svg class="profile_tabs__icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path d="M10.7071 2.29289C10.3166 1.90237 9.68342 1.90237 9.29289 2.29289L2.29289 9.29289C1.90237 9.68342 1.90237 10.3166 2.29289 10.7071C2.68342 11.0976 3.31658 11.0976 3.70711 10.7071L4 10.4142V17C4 17.5523 4.44772 18 5 18H7C7.55228 18 8 17.5523 8 17V15C8 14.4477 8.44772 14 9 14H11C11.5523 14 12 14.4477 12 15V17C12 17.5523 12.4477 18 13 18H15C15.5523 18 16 17.5523 16 17V10.4142L16.2929 10.7071C16.6834 11.0976 17.3166 11.0976 17.7071 10.7071C18.0976 10.3166 18.0976 9.68342 17.7071 9.29289L10.7071 2.29289Z" fill="currentColor"/>
                </svg>
                <span>Adres Bilgileri</span>
            </button>

            <button type="button" class="profile_tabs__nav_item" data-tab="job">
                <svg class="profile_tabs__icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path d="M6 6V5C6 3.34315 7.34315 2 9 2H11C12.6569 2 14 3.34315 14 5V6M3 6H17C17.5523 6 18 6.44772 18 7V16C18 17.1046 17.1046 18 16 18H4C2.89543 18 2 17.1046 2 16V7C2 6.44772 2.44772 6 3 6Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
                <span>Meslek & Gelir</span>
            </button>

            <button type="button" class="profile_tabs__nav_item" data-tab="wife">
                <svg class="profile_tabs__icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path d="M5 5C5 6.65685 6.34315 8 8 8C9.65685 8 11 6.65685 11 5C11 3.34315 9.65685 2 8 2C6.34315 2 5 3.34315 5 5ZM9 10C7.14348 10 5.36301 10.7375 4.05025 12.0503C2.7375 13.363 2 15.1435 2 17H14C14 15.1435 13.2625 13.363 11.9497 12.0503C10.637 10.7375 8.85652 10 9 10Z" fill="currentColor"/>
                    <path d="M15 5C15 6.65685 16.3431 8 18 8C19.6569 8 21 6.65685 21 5C21 3.34315 19.6569 2 18 2C16.3431 2 15 3.34315 15 5Z" fill="currentColor" opacity="0.6"/>
                </svg>
                <span>E≈ü & Aile Durumu</span>
            </button>

            <button type="button" class="profile_tabs__nav_item" data-tab="finance">
                <svg class="profile_tabs__icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path d="M10 2C5.58172 2 2 5.58172 2 10C2 14.4183 5.58172 18 10 18C14.4183 18 18 14.4183 18 10C18 5.58172 14.4183 2 10 2ZM9 6C9 5.44772 9.44772 5 10 5C10.5523 5 11 5.44772 11 6V7H12C12.5523 7 13 7.44772 13 8C13 8.55228 12.5523 9 12 9H11V11H12C12.5523 11 13 11.4477 13 12C13 12.5523 12.5523 13 12 13H11V14C11 14.5523 10.5523 15 10 15C9.44772 15 9 14.5523 9 14V13H8C7.44772 13 7 12.5523 7 12C7 11.4477 7.44772 11 8 11H9V9H8C7.44772 9 7 8.55228 7 8C7 7.44772 7.44772 7 8 7H9V6Z" fill="currentColor"/>
                </svg>
                <span>Varlƒ±k & Finans</span>
            </button>
        </div>

        <!-- Tab Content -->
        <div class="profile_tabs__content">
            <!-- ADDRESS TAB -->
            <div class="profile_tabs__panel profile_tabs__panel--active" data-panel="address">
                <form method="post" asp-page-handler="Address" class="profile_form">
                    @Html.AntiForgeryToken()
                    
                    <div class="profile_form__header">
                        <h3 class="profile_form__title">üè† Adres Bilgileri</h3>
                        <p class="profile_form__description">ƒ∞kamet adresinizi g√ºncelleyin.</p>
                    </div>

                    <div class="profile_form__grid">
                        <!-- City Dropdown -->
                        <div class="input_group">
                            <label class="input_group__label">≈ûehir *</label>
                            <select id="citySelect" class="input_group__field input_group__field--select" required>
                                <option value="">≈ûehir Se√ßiniz</option>
                            </select>
                            <input asp-for="AddressForm.CityId" type="hidden" id="cityIdInput" />
                            <span asp-validation-for="AddressForm.CityId" class="input_group__error"></span>
                        </div>

                        <!-- Town Dropdown -->
                        <div class="input_group">
                            <label class="input_group__label">ƒ∞l√ße *</label>
                            <select id="townSelect" class="input_group__field input_group__field--select" required disabled>
                                <option value="">√ñnce ≈üehir se√ßiniz</option>
                            </select>
                            <input asp-for="AddressForm.TownId" type="hidden" id="townIdInput" />
                            <span asp-validation-for="AddressForm.TownId" class="input_group__error"></span>
                        </div>

                        <!-- Address -->
                        <div class="input_group input_group--full">
                            <label class="input_group__label">A√ßƒ±k Adres *</label>
                            <textarea asp-for="AddressForm.Address" class="input_group__field input_group__field--textarea" rows="4" placeholder="√ñrn: Sokak, cadde, bina no, daire no..." required></textarea>
                            <span asp-validation-for="AddressForm.Address" class="input_group__error"></span>
                        </div>
                    </div>

                    <div class="profile_form__actions">
                        <button type="submit" class="btn_primary" data-loading-text="Kaydediliyor...">
                            Kaydet
                        </button>
                    </div>
                </form>
            </div>

            <!-- JOB TAB -->
            <div class="profile_tabs__panel" data-panel="job">
                <form method="post" asp-page-handler="Job" class="profile_form">
                    @Html.AntiForgeryToken()
                    
                    <div class="profile_form__header">
                        <h3 class="profile_form__title">üíº Meslek & Gelir Bilgileri</h3>
                        <p class="profile_form__description">ƒ∞≈ü durumunuz ve gelir bilgilerinizi g√ºncelleyin.</p>
                    </div>

                    <div class="profile_form__grid">
                        <!-- Company (Firma Adƒ±) -->
                        <div class="input_group">
                            <label class="input_group__label">Firma Adƒ±</label>
                            <input asp-for="JobForm.TitleCompany" type="text" class="input_group__field" id="jobCompany" placeholder="√ñrn: ABC Teknoloji A.≈û." />
                            <span asp-validation-for="JobForm.TitleCompany" class="input_group__error"></span>
                        </div>

                        <!-- Position (Unvan) -->
                        <div class="input_group">
                            <label class="input_group__label">Unvan</label>
                            <input asp-for="JobForm.CompanyPosition" type="text" class="input_group__field" id="jobPosition" placeholder="√ñrn: Kƒ±demli Yazƒ±lƒ±m Geli≈ütirici" />
                            <span asp-validation-for="JobForm.CompanyPosition" class="input_group__error"></span>
                        </div>

                        <!-- Sector (Sekt√∂r) - Dropdown -->
                        <div class="input_group">
                            <label class="input_group__label">Sekt√∂r</label>
                            <select id="jobGroupSelect" class="input_group__field input_group__field--select">
                                <option value="">Sekt√∂r Se√ßiniz</option>
                            </select>
                            <input asp-for="JobForm.JobGroupId" type="hidden" id="jobGroupIdInput" />
                            <span asp-validation-for="JobForm.JobGroupId" class="input_group__error"></span>
                        </div>

                        <!-- Employment Type (√áalƒ±≈üma Tipi) - Dropdown -->
                        <div class="input_group">
                            <label class="input_group__label">√áalƒ±≈üma Tipi</label>
                            <select id="workTypeSelect" class="input_group__field input_group__field--select">
                                <option value="">√áalƒ±≈üma Tipi Se√ßiniz</option>
                            </select>
                            <input asp-for="JobForm.CustomerWork" type="hidden" id="customerWorkInput" />
                            <span asp-validation-for="JobForm.CustomerWork" class="input_group__error"></span>
                        </div>

                        <!-- Start Date (ƒ∞≈üe Ba≈ülangƒ±√ß Tarihi) -->
                        <div class="input_group">
                            <label class="input_group__label">ƒ∞≈üe Ba≈ülangƒ±√ß Tarihi</label>
                            <input type="date" class="input_group__field" id="jobStartDate" />
                            <input asp-for="JobForm.WorkingYears" type="hidden" id="workingYearsInput" />
                            <input asp-for="JobForm.WorkingMonth" type="hidden" id="workingMonthInput" />
                        </div>

                        <!-- Monthly Income (Aylƒ±k Gelir) - UI Only -->
                        <div class="input_group">
                            <label class="input_group__label">Aylƒ±k Gelir (‚Ç∫)</label>
                            <input asp-for="JobForm.MonthlyIncome" type="number" class="input_group__field" placeholder="√ñrn: 15000" min="0" step="0.01" />
                        </div>
                    </div>

                    <div class="profile_form__actions">
                        <button type="submit" class="btn_primary" data-loading-text="Kaydediliyor..." id="jobSubmitBtn">
                            Kaydet
                        </button>
                    </div>
                </form>
            </div>

            <!-- WIFE TAB -->
            <div class="profile_tabs__panel" data-panel="wife">
                <form method="post" asp-page-handler="Wife" class="profile_form">
                    @Html.AntiForgeryToken()
                    
                    <div class="profile_form__header">
                        <h3 class="profile_form__title">üíç E≈ü & Aile Durumu</h3>
                        <p class="profile_form__description">Medeni durum ve e≈ü bilgilerinizi g√ºncelleyin.</p>
                    </div>

                    <div class="profile_form__grid">
                        <!-- Marital Status -->
                        <div class="input_group">
                            <select asp-for="WifeForm.MaritalStatus" class="input_group__field input_group__field--select" required>
                                <option value="">Medeni Durum Se√ßiniz *</option>
                                <option value="true">Evli</option>
                                <option value="false">Bekar</option>
                            </select>
                        </div>

                        <!-- Work Wife -->
                        <div class="input_group">
                            <select asp-for="WifeForm.WorkWife" class="input_group__field input_group__field--select" required>
                                <option value="">E≈üiniz √áalƒ±≈üƒ±yor mu? Se√ßiniz *</option>
                                <option value="true">Evet, √áalƒ±≈üƒ±yor</option>
                                <option value="false">Hayƒ±r, √áalƒ±≈ümƒ±yor</option>
                            </select>
                        </div>

                        <!-- Wife Salary Amount -->
                        <div class="input_group input_group--full">
                            <input asp-for="WifeForm.WifeSalaryAmount" type="number" class="input_group__field" placeholder="√ñrn: E≈ü Maa≈üƒ± (‚Ç∫) 65000 (Eƒüer √ßalƒ±≈üƒ±yorsa)" min="0" step="0.01" />
                        </div>
                    </div>

                    <div class="profile_form__actions">
                        <button type="submit" class="btn_primary" data-loading-text="Kaydediliyor...">
                            Kaydet
                        </button>
                    </div>
                </form>
            </div>

            <!-- FINANCE TAB -->
            <div class="profile_tabs__panel" data-panel="finance">
                <form method="post" asp-page-handler="Finance" class="profile_form">
                    @Html.AntiForgeryToken()
                    
                    <div class="profile_form__header">
                        <h3 class="profile_form__title">üí∞ Varlƒ±k & Finans Bilgileri</h3>
                        <p class="profile_form__description">ƒ∞≈ü sekt√∂r√º, maa≈ü bilgileriniz ve varlƒ±k durumunuzu g√ºncelleyin.</p>
                    </div>

                    <div class="profile_form__section">
                        <h4 class="profile_form__section_title">ƒ∞≈ü & Gelir Bilgileri</h4>
                        <div class="profile_form__grid">
                            <!-- Work Sector -->
                            <div class="input_group">
                                <select asp-for="FinanceForm.WorkSector" class="input_group__field input_group__field--select" required>
                                    <option value="">√áalƒ±≈ütƒ±ƒüƒ±nƒ±z Sekt√∂r Se√ßiniz *</option>
                                    <option value="1">Kamu</option>
                                    <option value="2">√ñzel Sekt√∂r</option>
                                    <option value="3">Serbest Meslek</option>
                                    <option value="4">Emekli</option>
                                    <option value="5">Diƒüer</option>
                                </select>
                            </div>

                            <!-- Salary Bank -->
                            <div class="input_group">
                                <input asp-for="FinanceForm.SalaryBank" type="text" class="input_group__field" placeholder="√ñrn: Maa≈ü Bankasƒ± - Ziraat" />
                            </div>

                            <!-- Salary Amount -->
                            <div class="input_group input_group--full">
                                <input asp-for="FinanceForm.SalaryAmount" type="number" class="input_group__field" placeholder="√ñrn: Maa≈ü Tutarƒ± (‚Ç∫) 50000" min="0" step="0.01" />
                            </div>
                        </div>
                    </div>

                    <div class="profile_form__section">
                        <h4 class="profile_form__section_title">Varlƒ±k Durumu</h4>
                        <div class="profile_form__grid">
                            <!-- Car Status -->
                            <div class="input_group">
                                <select asp-for="FinanceForm.CarStatus" class="input_group__field input_group__field--select" required>
                                    <option value="">Aracƒ±nƒ±z Var mƒ±? Se√ßiniz *</option>
                                    <option value="true">Evet, Ara√ß Sahibiyim</option>
                                    <option value="false">Hayƒ±r, Ara√ß Sahibi Deƒüilim</option>
                                </select>
                            </div>

                            <!-- House Status -->
                            <div class="input_group">
                                <select asp-for="FinanceForm.HouseStatus" class="input_group__field input_group__field--select" required>
                                    <option value="">Ev Sahibi misiniz? Se√ßiniz *</option>
                                    <option value="true">Evet, Ev Sahibiyim</option>
                                    <option value="false">Hayƒ±r, Kiracƒ±yƒ±m/Aile ile Oturuyorum</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="profile_form__actions">
                        <button type="submit" class="btn_primary" data-loading-text="Kaydediliyor...">
                            Kaydet
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/profile_tabs.js"></script>
    <script>
        // T√ºrkiye ≈ûehir ve ƒ∞l√ße Verisi
        const citiesData = [
            { "id": 34, "name": "ƒ∞stanbul", "towns": [ 
                { "id": 1, "name": "Kadƒ±k√∂y" }, 
                { "id": 2, "name": "Be≈üikta≈ü" }, 
                { "id": 3, "name": "√úsk√ºdar" },
                { "id": 4, "name": "≈ûi≈üli" },
                { "id": 5, "name": "Beyoƒülu" },
                { "id": 6, "name": "Fatih" },
                { "id": 7, "name": "Bakƒ±rk√∂y" },
                { "id": 8, "name": "Ata≈üehir" }
            ]},
            { "id": 6, "name": "Ankara", "towns": [ 
                { "id": 9, "name": "√áankaya" }, 
                { "id": 10, "name": "Ke√ßi√∂ren" },
                { "id": 11, "name": "Yenimahalle" },
                { "id": 12, "name": "Mamak" }
            ]},
            { "id": 35, "name": "ƒ∞zmir", "towns": [ 
                { "id": 13, "name": "Konak" }, 
                { "id": 14, "name": "Kar≈üƒ±yaka" },
                { "id": 15, "name": "Bornova" },
                { "id": 16, "name": "Bayraklƒ±" }
            ]},
            { "id": 1, "name": "Adana", "towns": [ 
                { "id": 17, "name": "Seyhan" },
                { "id": 18, "name": "Y√ºreƒüir" },
                { "id": 19, "name": "√áukurova" }
            ]},
            { "id": 42, "name": "Konya", "towns": [ 
                { "id": 20, "name": "Sel√ßuklu" }, 
                { "id": 21, "name": "Meram" },
                { "id": 22, "name": "Karatay" }
            ]},
            { "id": 7, "name": "Antalya", "towns": [
                { "id": 23, "name": "Muratpa≈üa" },
                { "id": 24, "name": "Kepez" },
                { "id": 25, "name": "Konyaaltƒ±" }
            ]},
            { "id": 16, "name": "Bursa", "towns": [
                { "id": 26, "name": "Osmangazi" },
                { "id": 27, "name": "Nil√ºfer" },
                { "id": 28, "name": "Yƒ±ldƒ±rƒ±m" }
            ]}
        ];

        // Mevcut deƒüerler (API'den gelen)
        const currentCityId = @(Model.AddressForm?.CityId ?? 0);
        const currentTownId = @(Model.AddressForm?.TownId ?? 0);

        $(document).ready(function() {
            const $citySelect = $('#citySelect');
            const $townSelect = $('#townSelect');
            const $cityIdInput = $('#cityIdInput');
            const $townIdInput = $('#townIdInput');

            // ≈ûehir dropdown'ƒ±nƒ± doldur
            citiesData.forEach(function(city) {
                const $option = $('<option></option>')
                    .attr('value', city.id)
                    .text(city.name);
                $citySelect.append($option);
            });

            // Mevcut ≈üehri se√ß
            if (currentCityId && currentCityId > 0) {
                $citySelect.val(currentCityId);
                $cityIdInput.val(currentCityId);
                
                // Se√ßili ≈üehrin il√ßelerini y√ºkle
                loadTowns(currentCityId);
            }

            // ≈ûehir se√ßildiƒüinde
            $citySelect.on('change', function() {
                const selectedCityId = parseInt($(this).val());
                
                if (selectedCityId > 0) {
                    // Hidden input'u g√ºncelle
                    $cityIdInput.val(selectedCityId);
                    
                    // ƒ∞l√ße dropdown'ƒ±nƒ± aktif et ve doldur
                    $townSelect.prop('disabled', false);
                    loadTowns(selectedCityId);
                    
                    // ƒ∞l√ße se√ßimini sƒ±fƒ±rla
                    $townSelect.val('');
                    $townIdInput.val('');
                } else {
                    // ≈ûehir se√ßimi kaldƒ±rƒ±ldƒ±ysa
                    $cityIdInput.val('');
                    $townSelect.prop('disabled', true);
                    $townSelect.html('<option value="">√ñnce ≈üehir se√ßiniz</option>');
                    $townIdInput.val('');
                }
            });

            // ƒ∞l√ße se√ßildiƒüinde
            $townSelect.on('change', function() {
                const selectedTownId = parseInt($(this).val());
                if (selectedTownId > 0) {
                    $townIdInput.val(selectedTownId);
                } else {
                    $townIdInput.val('');
                }
            });

            // ƒ∞l√ßeleri y√ºkle
            function loadTowns(cityId) {
                const selectedCity = citiesData.find(function(city) {
                    return city.id === cityId;
                });

                if (selectedCity && selectedCity.towns) {
                    $townSelect.html('<option value="">ƒ∞l√ße Se√ßiniz</option>');
                    
                    selectedCity.towns.forEach(function(town) {
                        const $option = $('<option></option>')
                            .attr('value', town.id)
                            .text(town.name);
                        $townSelect.append($option);
                    });

                    // Mevcut il√ßeyi se√ß
                    if (currentTownId && currentTownId > 0) {
                        $townSelect.val(currentTownId);
                        $townIdInput.val(currentTownId);
                    }
                } else {
                    $townSelect.html('<option value="">ƒ∞l√ße bulunamadƒ±</option>');
                }
            }

            // Restore active tab if returning from post
            @if (!string.IsNullOrEmpty(Model.ActiveTab))
            {
                <text>
                switch_tab('@Model.ActiveTab');
                </text>
            }
        });

        // ========================================================================
        // JOB TAB - Dropdown and Date Calculation Logic
        // ========================================================================
        
        // Sekt√∂r Gruplarƒ± (Job Groups)
        const jobGroups = [
            { id: 1, name: "Eƒüitim" },
            { id: 2, name: "Saƒülƒ±k" },
            { id: 3, name: "Bili≈üim/Teknoloji" },
            { id: 4, name: "Finans" },
            { id: 5, name: "ƒ∞n≈üaat" },
            { id: 6, name: "Tarƒ±m" },
            { id: 7, name: "Ticaret" },
            { id: 8, name: "Turizm" },
            { id: 9, name: "√úretim" },
            { id: 10, name: "Diƒüer" }
        ];

        // √áalƒ±≈üma Tipleri (Work Types)
        const workTypes = [
            { id: 1, name: "√úcretli √ßalƒ±≈üan" },
            { id: 2, name: "Kamu √áalƒ±≈üanƒ±" },
            { id: 3, name: "Emekli" },
            { id: 4, name: "Serbest Meslek" },
            { id: 5, name: "√ñƒürenci" }
        ];

        // Mevcut deƒüerler (API'den gelen)
        const currentJobGroupId = @(Model.JobForm?.JobGroupId ?? 0);
        const currentCustomerWork = @(Model.JobForm?.CustomerWork ?? 0);
        const currentWorkingYears = @(Model.JobForm?.WorkingYears ?? 0);
        const currentWorkingMonth = @(Model.JobForm?.WorkingMonth ?? 0);

        $(document).ready(function() {
            const $jobGroupSelect = $('#jobGroupSelect');
            const $workTypeSelect = $('#workTypeSelect');
            const $jobGroupIdInput = $('#jobGroupIdInput');
            const $customerWorkInput = $('#customerWorkInput');
            const $jobStartDate = $('#jobStartDate');
            const $workingYearsInput = $('#workingYearsInput');
            const $workingMonthInput = $('#workingMonthInput');

            // Sekt√∂r dropdown'ƒ±nƒ± doldur
            jobGroups.forEach(function(group) {
                const $option = $('<option></option>')
                    .attr('value', group.id)
                    .text(group.name);
                $jobGroupSelect.append($option);
            });

            // √áalƒ±≈üma Tipi dropdown'ƒ±nƒ± doldur
            workTypes.forEach(function(type) {
                const $option = $('<option></option>')
                    .attr('value', type.id)
                    .text(type.name);
                $workTypeSelect.append($option);
            });

            // Mevcut se√ßimleri set et
            if (currentJobGroupId && currentJobGroupId > 0) {
                $jobGroupSelect.val(currentJobGroupId);
                $jobGroupIdInput.val(currentJobGroupId);
            }

            if (currentCustomerWork && currentCustomerWork > 0) {
                $workTypeSelect.val(currentCustomerWork);
                $customerWorkInput.val(currentCustomerWork);
            }

            // Tarihi hesapla ve set et (workingYears ve workingMonth'dan)
            if (currentWorkingYears !== null && currentWorkingMonth !== null) {
                const calculatedDate = calculateStartDateFromYearsAndMonths(currentWorkingYears, currentWorkingMonth);
                if (calculatedDate) {
                    $jobStartDate.val(calculatedDate);
                }
            }

            // Sekt√∂r se√ßildiƒüinde
            $jobGroupSelect.on('change', function() {
                const selectedId = parseInt($(this).val());
                if (selectedId > 0) {
                    $jobGroupIdInput.val(selectedId);
                } else {
                    $jobGroupIdInput.val('');
                }
            });

            // √áalƒ±≈üma Tipi se√ßildiƒüinde
            $workTypeSelect.on('change', function() {
                const selectedId = parseInt($(this).val());
                if (selectedId > 0) {
                    $customerWorkInput.val(selectedId);
                } else {
                    $customerWorkInput.val('');
                }
            });

            // Tarih deƒüi≈ütiƒüinde workingYears ve workingMonth hesapla
            $jobStartDate.on('change', function() {
                const selectedDate = $(this).val();
                if (selectedDate) {
                    const { years, months } = calculateYearsAndMonthsFromDate(selectedDate);
                    $workingYearsInput.val(years);
                    $workingMonthInput.val(months);
                } else {
                    $workingYearsInput.val('');
                    $workingMonthInput.val('');
                }
            });

            // Form submit validation
            $('form[asp-page-handler="Job"]').on('submit', function(e) {
                // Hidden input'larƒ±n dolu olduƒüunu kontrol et
                if ($jobGroupIdInput.val() === '' || $jobGroupIdInput.val() === '0') {
                    e.preventDefault();
                    alert('L√ºtfen bir sekt√∂r se√ßiniz.');
                    return false;
                }

                if ($customerWorkInput.val() === '' || $customerWorkInput.val() === '0') {
                    e.preventDefault();
                    alert('L√ºtfen bir √ßalƒ±≈üma tipi se√ßiniz.');
                    return false;
                }

                // Tarih se√ßilmi≈üse workingYears ve workingMonth'u hesapla
                if ($jobStartDate.val() && ($workingYearsInput.val() === '' || $workingMonthInput.val() === '')) {
                    const selectedDate = $jobStartDate.val();
                    const { years, months } = calculateYearsAndMonthsFromDate(selectedDate);
                    $workingYearsInput.val(years);
                    $workingMonthInput.val(months);
                }

                // Tarih se√ßilmemi≈üse workingYears ve workingMonth'u 0 yap (isteƒüe baƒülƒ±)
                if (!$jobStartDate.val()) {
                    $workingYearsInput.val(0);
                    $workingMonthInput.val(0);
                }
            });

            // Tarihten yƒ±l ve ay hesapla
            function calculateYearsAndMonthsFromDate(startDateString) {
                const startDate = new Date(startDateString);
                const today = new Date();
                
                let years = today.getFullYear() - startDate.getFullYear();
                let months = today.getMonth() - startDate.getMonth();
                
                if (months < 0) {
                    years--;
                    months += 12;
                }
                
                // G√ºn kontrol√º (eƒüer bug√ºn√ºn g√ºn√º ba≈ülangƒ±√ß tarihinden k√º√ß√ºkse bir ay eksilt)
                if (today.getDate() < startDate.getDate()) {
                    months--;
                    if (months < 0) {
                        years--;
                        months += 12;
                    }
                }
                
                return { years: years, months: months };
            }

            // Yƒ±l ve aydan tarih hesapla (geriye d√∂n√ºk)
            function calculateStartDateFromYearsAndMonths(years, months) {
                if (!years && !months) return null;
                
                const today = new Date();
                const calculatedDate = new Date(today);
                
                calculatedDate.setFullYear(today.getFullYear() - years);
                calculatedDate.setMonth(today.getMonth() - months);
                
                // Ay ta≈ümasƒ± kontrol√º
                if (calculatedDate.getMonth() > today.getMonth()) {
                    calculatedDate.setFullYear(calculatedDate.getFullYear() - 1);
                }
                
                // Format: YYYY-MM-DD
                const year = calculatedDate.getFullYear();
                const month = String(calculatedDate.getMonth() + 1).padStart(2, '0');
                const day = String(calculatedDate.getDate()).padStart(2, '0');
                
                return `${year}-${month}-${day}`;
            }
        });
    </script>
}

